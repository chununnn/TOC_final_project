<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ç®—å‘½æ©Ÿå™¨äºº</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-cover bg-center bg-no-repeat flex items-center justify-center"
      style="background-image: url('./images/BG1.jpg');">

  <!-- ç»ç’ƒæ„ŸèŠå¤©æ¡†ï¼ˆæ”¹æˆé»‘å­—ï¼‰ -->
  <div class="w-full max-w-xl bg-white/20 backdrop-blur-xl border border-white/30 shadow-2xl rounded-2xl p-6 flex flex-col h-[80vh] text-black">

    <h1 class="text-2xl font-bold mb-4 drop-shadow-lg">ç®—å‘½æ©Ÿå™¨äºº</h1>

    <!-- èŠå¤©å€ï¼ˆç»ç’ƒæ„Ÿ + é»‘å­—ï¼‰ -->
    <div id="chatBox"
         class="flex-1 overflow-y-auto rounded-lg p-3 bg-white/10 backdrop-blur-sm border border-white/20 space-y-3 shadow-inner text-black">
    </div>

    <!-- è¼¸å…¥æ¡†ï¼ˆç»ç’ƒæ„Ÿ + é»‘å­—ï¼‰ -->
    <div class="mt-4 flex gap-2">
      <input id="userInput"
             type="text"
             placeholder="Type something..."
             class="flex-1 bg-white/30 backdrop-blur-sm border border-white/30 rounded-lg px-3 py-2 text-black placeholder-gray-600 focus:ring-2 focus:ring-blue-300 outline-none">

      <button id="sendBtn"
              onclick="sendMessage()"
              class="px-4 py-2 bg-blue-500/40 backdrop-blur-sm text-black rounded-lg border border-white/30 hover:bg-blue-500/60 transition">
        Send
      </button>
    </div>

  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");

    let isLoading = false;
    let isTyping = false;
    let interruptTyping = false;

    function lockInput() {
      userInput.disabled = true;
      sendBtn.disabled = true;
      userInput.classList.add("opacity-50", "cursor-not-allowed");
      sendBtn.classList.add("opacity-50", "cursor-not-allowed");
    }

    function unlockInput() {
      userInput.disabled = false;
      sendBtn.disabled = false;
      userInput.classList.remove("opacity-50", "cursor-not-allowed");
      sendBtn.classList.remove("opacity-50", "cursor-not-allowed");
      userInput.focus();
    }

    function addMessage(text, sender) {
      const bubble = document.createElement("div");
      bubble.className = sender === "user" ? "text-right" : "text-left";

      bubble.innerHTML = `
        <div class="inline-block px-4 py-2 rounded-lg shadow
                    ${sender === "user"
                      ? "bg-blue-300/60 backdrop-blur-sm text-black border border-white/20"
                      : "bg-white/50 backdrop-blur-sm text-black border border-white/20"}
                    animate-fadeIn">
          ${text}
        </div>
      `;

      chatBox.appendChild(bubble);
      chatBox.scrollTop = chatBox.scrollHeight;

      return bubble;
    }

    function typeWriterEffect(targetElement, text, speed = 25) {
      isTyping = true;
      interruptTyping = false;

      targetElement.innerHTML = "";
      let i = 0;

      function type() {
        if (interruptTyping) {
          targetElement.innerHTML = text;
          chatBox.scrollTop = chatBox.scrollHeight;
          isTyping = false;
          return;
        }

        if (i < text.length) {
          targetElement.innerHTML += text[i];
          i++;
          chatBox.scrollTop = chatBox.scrollHeight;
          setTimeout(type, speed);
        } else {
          isTyping = false;
        }
      }

      type();
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      if (isTyping) {
        interruptTyping = true;
        return;
      }

      if (isLoading) return;

      addMessage(text, "user");
      userInput.value = "";

      lockInput();
      isLoading = true;

      const loadingBubble = addMessage(
        `<span class="wave">
            <span>æ­£</span><span>åœ¨</span><span>æŸ¥</span><span>è©¢</span><span>ä¸­</span><span>.</span><span>.</span><span>.</span>
         </span>`,
        "bot"
      );

      try {
        const response = await fetch("http://127.0.0.1:5000/api/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });

        const data = await response.json();

        loadingBubble.remove();
        isLoading = false;

        const botBubble = addMessage("", "bot");
        const innerDiv = botBubble.querySelector("div");

        unlockInput();
        typeWriterEffect(innerDiv, data.result.join("<br>"));

      } catch (err) {
        loadingBubble.remove();
        isLoading = false;
        unlockInput();
        addMessage("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦", "bot");
      }
    }

    userInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    });

    function showFortuneButton() {
      const btn = document.createElement("button");
      btn.innerText = "ğŸ¥  å¹¸é‹é¤…ä¹¾";
      btn.className =
        "mt-3 px-4 py-2 bg-orange-300/70 backdrop-blur-sm text-black rounded-lg border border-white/30 hover:bg-orange-400/80 transition";

      btn.onclick = function () {
        userInput.value = "çµ¦æˆ‘ä¸€å€‹å¹¸é‹é¤…ä¹¾";
        sendMessage();
        btn.remove();
      };

      chatBox.appendChild(btn);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    window.onload = function () {
      const introBubble = addMessage("", "bot");
      const innerDiv = introBubble.querySelector("div");

      typeWriterEffect(innerDiv, "å—¨ï¼Œæˆ‘æ˜¯ä½ çš„ç®—å‘½æ©Ÿå™¨äººï¼è«‹è¼¸å…¥ä½ çš„å•é¡Œï¼Œæˆ‘æœƒç›¡åŠ›ç‚ºä½ è§£æã€‚", 25);

      setTimeout(() => {
        showFortuneButton();
      }, 2000);
    };
  </script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.25s ease-out;
    }

    /* ä¿®æ­£æ³¢æµªé¡è‰² â†’ æ›´æ·±ã€æ›´æ˜é¡¯ */
    /* æ³¢æµªå‹•ç•« */
.wave span {
  display: inline-block;
  animation: wave 1.6s infinite ease-in-out, colorchange 2s infinite alternate;
}

.wave span:nth-child(1) { animation-delay: 0s, 0s; }
.wave span:nth-child(2) { animation-delay: 0.1s, 0.1s; }
.wave span:nth-child(3) { animation-delay: 0.2s, 0.2s; }
.wave span:nth-child(4) { animation-delay: 0.3s, 0.3s; }
.wave span:nth-child(5) { animation-delay: 0.4s, 0.4s; }
.wave span:nth-child(6) { animation-delay: 0.5s, 0.5s; }
.wave span:nth-child(7) { animation-delay: 0.6s, 0.6s; }
.wave span:nth-child(8) { animation-delay: 0.7s, 0.7s; }

@keyframes wave {
  0%   { transform: translateY(0); }
  25%  { transform: translateY(-6px); }
  50%  { transform: translateY(0); }
  81.25% { transform: translateY(0); } /* â­ åœé “ 0.5 ç§’ */
  100% { transform: translateY(0); }
}



    @keyframes colorchange {
    0%   { color: #6b7280; }
    50%  { color: #3b82f6; }
    100% { color: #10b981; }
    }

  </style>

</body>
</html>
