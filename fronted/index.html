<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ç®—å‘½æ©Ÿå™¨äºº</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 flex justify-center py-4">

  <!-- ç™½æ¡†ï¼šå›ºå®šé«˜åº¦ + flex column -->
  <div class="w-full max-w-xl bg-white shadow-xl rounded-xl p-4 flex flex-col h-[80vh]">

    <h1 class="text-2xl font-bold mb-4 text-gray-800">ç®—å‘½æ©Ÿå™¨äºº</h1>

    <!-- èŠå¤©å€ -->
    <div id="chatBox" class="flex-1 overflow-y-auto border rounded-lg p-3 bg-gray-50 space-y-3"></div>

    <!-- è¼¸å…¥æ¡† -->
    <div class="mt-4 flex gap-2">
      <input id="userInput"
             type="text"
             placeholder="Type something..."
             class="flex-1 border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 outline-none">

      <button id="sendBtn"
              onclick="sendMessage()"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
        Send
      </button>
    </div>

  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");

    let isLoading = false;        // æ˜¯å¦æ­£åœ¨æŸ¥è©¢ä¸­
    let isTyping = false;         // æ˜¯å¦æ­£åœ¨æ‰“å­—å‹•ç•«
    let interruptTyping = false;  // æ˜¯å¦è¦ä¸­æ–·æ‰“å­—å‹•ç•«

    function lockInput() {
      userInput.disabled = true;
      sendBtn.disabled = true;
      userInput.classList.add("opacity-50", "cursor-not-allowed");
      sendBtn.classList.add("opacity-50", "cursor-not-allowed");
    }

    function unlockInput() {
      userInput.disabled = false;
      sendBtn.disabled = false;
      userInput.classList.remove("opacity-50", "cursor-not-allowed");
      sendBtn.classList.remove("opacity-50", "cursor-not-allowed");
      userInput.focus();
    }

    function addMessage(text, sender) {
      const bubble = document.createElement("div");
      bubble.className = sender === "user" ? "text-right" : "text-left";

      bubble.innerHTML = `
        <div class="inline-block px-4 py-2 rounded-lg shadow 
                    ${sender === "user" ? "bg-blue-500 text-white" : "bg-gray-200 text-gray-800"}
                    animate-fadeIn">
          ${text}
        </div>
      `;

      chatBox.appendChild(bubble);
      chatBox.scrollTop = chatBox.scrollHeight;

      return bubble;
    }

    // ğŸ”¥ æ‰“å­—æ©Ÿæ•ˆæœï¼ˆå¯è¢«ä¸­æ–· + è·³åˆ°çµå°¾ï¼‰
    function typeWriterEffect(targetElement, text, speed = 25) {
      isTyping = true;
      interruptTyping = false;

      targetElement.innerHTML = "";
      let i = 0;

      function type() {
        if (interruptTyping) {
          targetElement.innerHTML = text; // ç›´æ¥è·³åˆ°çµå°¾
          chatBox.scrollTop = chatBox.scrollHeight;
          isTyping = false;
          return;
        }

        if (i < text.length) {
          targetElement.innerHTML += text[i];
          i++;
          chatBox.scrollTop = chatBox.scrollHeight;
          setTimeout(type, speed);
        } else {
          isTyping = false;
        }
      }

      type();
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      // ğŸ”¥ å¦‚æœæ­£åœ¨æ‰“å­— â†’ ä¸­æ–·ä¸¦è·³åˆ°çµå°¾
      if (isTyping) {
        interruptTyping = true;
        return;
      }

      // ğŸ”¥ å¦‚æœæ­£åœ¨ loading â†’ ä¸å…è¨±è¼¸å…¥
      if (isLoading) return;

      addMessage(text, "user");
      userInput.value = "";

      // ğŸ”¥ é–ä½è¼¸å…¥æ¡†ï¼ˆloading ä¸­ï¼‰
      lockInput();
      isLoading = true;

      // loading å‹•ç•«
      const loadingBubble = addMessage(
        `<span class="wave">
            <span>æ­£</span><span>åœ¨</span><span>æŸ¥</span><span>è©¢</span><span>ä¸­</span><span>.</span><span>.</span><span>.</span>
         </span>`,
        "bot"
      );

      try {
        const response = await fetch("http://127.0.0.1:5000/api/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });

        const data = await response.json();

        loadingBubble.remove();
        isLoading = false;

        // å»ºç«‹ç©ºæ³¡æ³¡
        const botBubble = addMessage("", "bot");
        const innerDiv = botBubble.querySelector("div");

        // ğŸ”¥ è§£é–è¼¸å…¥æ¡†ï¼ˆé–‹å§‹æ‰“å­—å‹•ç•«ï¼‰
        unlockInput();

        // ğŸ”¥ æ‰“å­—å‹•ç•«ï¼ˆå¯è¢«ä¸­æ–·ï¼‰
        typeWriterEffect(innerDiv, data.result.join("<br>"));

      } catch (err) {
        loadingBubble.remove();
        isLoading = false;
        unlockInput();
        addMessage("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦", "bot");
      }
    }

    // Enter é€å‡ºè¨Šæ¯
    userInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    });
    function showFortuneButton() {
        const btn = document.createElement("button");
        btn.innerText = "ğŸ¥  å¹¸é‹é¤…ä¹¾";
        btn.className =
            "mt-3 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition";

        btn.onclick = function () {
            // ä½ æƒ³è¦æŒ‰ä¸‹å¾Œé€å‡ºçš„è¨Šæ¯
            userInput.value = "çµ¦æˆ‘ä¸€å€‹å¹¸é‹é¤…ä¹¾";
            sendMessage();
            btn.remove(); // æŒ‰ä¸‹å¾Œç§»é™¤æŒ‰éˆ•ï¼ˆé¿å…é‡è¤‡ï¼‰
        };

        chatBox.appendChild(btn);
        chatBox.scrollTop = chatBox.scrollHeight;
        }
    window.onload = function () {
    const introBubble = addMessage("", "bot");
    const innerDiv = introBubble.querySelector("div");

    typeWriterEffect(innerDiv, "å—¨ï¼Œæˆ‘æ˜¯ä½ çš„ç®—å‘½æ©Ÿå™¨äººï¼è«‹è¼¸å…¥ä½ çš„å•é¡Œï¼Œæˆ‘æœƒç›¡åŠ›ç‚ºä½ è§£æã€‚", 25);

    // ç­‰æ‰“å­—å‹•ç•«çµæŸå¾Œé¡¯ç¤ºæŒ‰éˆ•
    setTimeout(() => {
        showFortuneButton();
    }, 2000); // ä¾ç…§ä½ çš„æ‰“å­—é€Ÿåº¦èª¿æ•´
    };


  </script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.25s ease-out;
    }

    /* æ³¢æµªå‹•ç•« */
    .wave span {
      display: inline-block;
      animation: wave 1.6s infinite ease-in-out, colorchange 2s infinite alternate;
    }

    .wave span:nth-child(1) { animation-delay: 0s, 0s; }
    .wave span:nth-child(2) { animation-delay: 0.1s, 0.1s; }
    .wave span:nth-child(3) { animation-delay: 0.2s, 0.2s; }
    .wave span:nth-child(4) { animation-delay: 0.3s, 0.3s; }
    .wave span:nth-child(5) { animation-delay: 0.4s, 0.4s; }
    .wave span:nth-child(6) { animation-delay: 0.5s, 0.5s; }
    .wave span:nth-child(7) { animation-delay: 0.6s, 0.6s; }
    .wave span:nth-child(8) { animation-delay: 0.7s, 0.7s; }

    @keyframes wave {
      0%   { transform: translateY(0); }
      25%  { transform: translateY(-6px); }
      50%  { transform: translateY(0); }
      100% { transform: translateY(0); }
    }

    @keyframes colorchange {
      0%   { color: #6b7280; }
      50%  { color: #3b82f6; }
      100% { color: #10b981; }
    }
  </style>

</body>
</html>